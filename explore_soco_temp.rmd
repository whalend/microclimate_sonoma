---
title: "Explore SoCo Temperature"
author: "whalen"
date: "June 12, 2015"
output: html_document
---

```{r load data}
long_temp <- readRDS("Temperature/eof_pred_long.rds")# long format
wide_temp <- readRDS("Temperature/eof_pred_wide.rds")
```

```{r examine/compare data structure, message=FALSE}
str(long_temp)
str(wide_temp)
names(long_temp)
names(wide_temp)
summary(long_temp)
summary(wide_temp)

library(plyr); library(dplyr)
long_temp <- select (long_temp, -posix_time)
long_temp$date <- as.Date(long_temp$chr_date, format = "%Y-%m-%d %H")
```


### Subset data to rainy season temperature variables for each sampling year

First, I added a variable to indicate the year of disease sampling the rainy season range of dates represents. The "rainy season" is defined here as November 1st - May 31st.

```{r create sample season indicator, message=FALSE}
library(dplyr)
long_temp <-  long_temp %>% mutate(sample_year = ifelse(
      date >= "2003-11-01" & date <= "2004-05-31", 2004, 
      ifelse(date >= "2004-11-01" & date <= "2005-05-31", 2005,
             ifelse(date >= "2005-11-01" & date <= "2006-05-31", 2006,
                    ifelse(date >= "2006-11-01" & date <= "2007-05-31", 2007,
                           ifelse(date >= "2007-11-01" & date <= "2008-05-31", 2008,
                                  ifelse(date >= "2008-11-01" & date <= "2009-05-31", 2009,
                                         ifelse(date >= "2009-11-01" & date <= "2010-05-31", 2010,
                                                ifelse(date >= "2010-11-01" & date <= "2011-05-31", 2011, ifelse(date >= "2011-11-01" & date <= "2012-05-31", 2012,
                                                                                                           ifelse(date >= "2013-11-01" & date <= "2014-05-31", 2014, NA)))))))))))
```

Now I use the `sample_year` as a grouping variable to calculate the various temperature variables.

```{r calculate hour counts}
# hours at "optimal" temperature, 14-20 C
rainy_season_temps <- long_temp %>% filter(temp >= 14 & temp <= 20) %>% 
      group_by(plotid, sample_year) %>% summarise(hrs_14_20 = length(temp))

# hours at dessicating, slow/no growth temperatures, >= 25 C
rainy_season_temps <- left_join(rainy_season_temps, long_temp %>% 
                                  filter(temp >= 25) %>%
                                  group_by(plotid, sample_year) %>%
                                  summarise(hrs_abv25 = length(temp)),
                            by = c("plotid", "sample_year"))

# hours at cool slow growing temperatures, <= 10 C
rainy_season_temps <- left_join(rainy_season_temps, long_temp %>% 
      filter(temp <= 10) %>% 
      group_by(plotid, sample_year) %>% summarise(hrs_blw10 = length(temp)),
      by = c("plotid", "sample_year"))

rainy_season_temps <- left_join(rainy_season_temps, long_temp %>% 
                                  group_by(plotid, sample_year, date) %>% 
      summarise(daily_tmax = max(temp), daily_tmin = min(temp)) %>% 
      group_by(plotid, sample_year) %>% 
      summarise(avg_tmax = mean(daily_tmax), avg_tmin = mean(daily_tmin)),
      by = c("plotid", "sample_year"))

write.csv(rainy_season_temps, "~/GitHub/superspreaders/analysis/data/rainy_season_temps.csv")
```


```{r plotting}
library(ggplot2)
# Subset to fewer plots
dt <- long_temp %>%
      select(year, temp, plotid, date) %>%
      group_by(as.factor(year)) %>%
      filter(plotid == "ANN01" | plotid == "SUGAR23" | plotid == "FOP04")

qplot(x = year, y = avg_temp_yr, 
      data = dt %>% 
            group_by(year, plotid) %>%
            select(year, plotid, temp) %>% 
            summarise(avg_temp_yr = mean(temp)),
      facet = plotid ~ ., color = plotid, geom = c("point", "line")
            )
```

